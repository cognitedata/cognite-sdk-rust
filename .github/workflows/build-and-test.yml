name: Build and test SDK

on:
  pull_request:
    branches: [master]
  push:
    branches: [master]

jobs:
  build_and_test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install build dependencies
        run: sudo apt-get install protobuf-compiler
      - uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          components: rustfmt, clippy
      - name: Run clippy
        run: cargo clippy -- -D warnings
      - name: Run cargo format
        run: cargo fmt --check
      - name: Test
        run: cargo test
        env:
          COGNITE_PROJECT: opcua-interface-test
          COGNITE_BASE_URL: https://greenfield.cognitedata.com
          COGNITE_TOKEN_URL: ${{ secrets.TOKEN_URL }}
          COGNITE_SCOPES: https://greenfield.cognitedata.com/.default
          COGNITE_CLIENT_ID: ${{ secrets.CLIENT_ID }}
          COGNITE_CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
      - name: Build docs
        env:
          RUSTDOCFLAGS: "-D warnings"
        run: >
          cargo doc --no-deps
          && rm -rf ./docs
          && echo "<meta http-equiv=\"refresh\" content=\"0; url=cognite/index.html\">" > target/doc/index.html
          && cp -r target/doc ./docs
      - name: Fix permissions
        run: |
          chmod -c -R +rX "docs/" | while read line; do
            echo "::warning title=Invalid file permissions automatically fixed::$line"
          done
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "docs/"
  deploy-docs:
    needs: build_and_test
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
      
        
